name: Integration Tests
on:
  push:
    branches: [main]

jobs:
  # TODO: Add pre commit checks
  # pre-commit:
  #   uses: ./.github/workflows/pre-commit.yml

  # TODO: Add Nvidia integration tests
  # integration-tests-nvidia:

  integration-tests-amd:
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 60
    strategy:
      matrix:
        runner: "amd-gfx942-mi300"
        include:
          # - image: "rocm/rocm-6.4-py310-torch25-241101-3"
          - image: "rocm/pytorch:rocm6.1_ubuntu22.04_py3.10_pytorch_2.4"
            runner: ["amd-gfx942-mi300"]
    env:
      PYTHON: "python3"

    container:
      - name: "AMD Integration Tests"
        image: ${{ matrix.image }}
        options: --user root

    steps:
      - name: Checkout
        # uses: actions/checkout@v3
        # with:
        #   submodules: 'recursive'
        run: |
          git clone https://github.com/ByteDance-Seed/Triton-distributed.git
          cd Triton-distributed/
          git submodule update --init --recursive

      - name: Install dependencies
        run: |
          echo "Install dependencies..."
          sudo apt-get update -y
          sudo apt install -y libopenmpi-dev
          pip3 install --pre torch --index-url https://download.pytorch.org/whl/nightly/rocm6.3 --no-deps
          bash ./shmem/rocshmem_bind/build.sh
          python3 -m pip install -i https://test.pypi.org/simple hip-python>=6.3.0 # (or whatever Rocm version you have)
          pip3 install pybind11

      - name: Build
        runs: |
          echo "Building Triton-distributed..."
          pip3 install -e python --verbose --no-build-isolation --use-pep517


      - name: Run AMD Integration Tests
        run: |
          echo "Running AMD integration tests..."
          bash ./scripts/launch_amd.sh ./python/triton_dist/test/amd/test_ag_gemm_intra_node.py 8192 8192 29568

